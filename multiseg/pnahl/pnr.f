	PROGRAM PNR
C  PROGRAM TO READ AN OUTPUT FILE FROM PN.F
C   AND COMPUTE THE REABSORPTIVE FLUXES IN EACH SEGMENT
C
C
	INTEGER NWR,IWR(20),JWR(20),CHOP(7),DCHOP(7)
	REAL WRRES(8,20,50),RDRES(20),WRDL(8,20,50),DL(20),
     1    WREX(8,20,50),EX(20),TTIM,WRTIM(8,50),SCALE(20)
        CHARACTER*12 IPTFIL,OPTFIL,VARNAM
        CHARACTER*5 VNAME1(20),VNAME2(20),SWI
C
C NWR-	NUMBER OF RESULTS TO BE REWRITTEN (UP TO 20)
C IWR,JWR-	LOCATION OF RESULT IN RESULT TABLE
C KXP-	NUMBER OF EXPERIMENTS (UP TO 50)
C CHOP- SPATIAL CHOP OF TUBULE SEGMENT OF INTEREST
C DCHOP-COARSER CHOP RESOLUTION FOR PRINTING (NOT USED HERE)
C WRRES(I,J,K)-	REABSORPTION OF J IN SEGMENT I DURING EXPT. K
C WRDL(I,J,K)-	DELIVERY OF J TO SEGMENT I DURING EXPT. K
C WREX(I,J,K)-	OUTFLOW OF J FROM SEGMENT I DURING EXPT. K
C WRTIM(I,K)-	TRANSIT TIME IN SEGMENT I DURING EXPT. K
C
	CHARACTER*5 SEGNAMSF(5),SEGNAMJM(7)
	CHARACTER*2 SWNEPH
C	SWNEPH-	DIRECTING THE CALCULATION TO SF (SFPCT, SFPST, SDHL)
C       	OR JM NEPHRON (JMPCT, JMPST, LDHLU, LDHLL, TAHL)
C
	COMMON/TWR/NWR,IWR,JWR,TTIM,RDRES,DL,EX
	DATA SEGNAMSF
     1   /'SFPCT','SFPST',' SDHL',' AHLM',' AHLC'/
	DATA SEGNAMJM
     1   /'JMPCT','JMPST','LDHLU','LDHLL',' TAHL',' AHLM',' AHLC'/
C
	PRINT 2
    2   FORMAT(' TYPE THE INPUT FILENAME:',$)
	READ 4, IPTFIL
    4   FORMAT(A12)
C	PRINT 6
C    6   FORMAT(' TYPE THE OUTPUT FILENAME:',$)
C	READ 4, OPTFIL
	OPEN(1,FILE=IPTFIL)
	OPEN(2,FILE='xy.pnr')
C
	PRINT 100
  100   FORMAT(' SUPERFICIAL OR JUXTAMEDULLARY (sf/jm): ',$)
	READ *, SWNEPH
	IF (SWNEPH.EQ.'sf') THEN
	NSEG=5
	OPEN(4,FILE='pnmeshsf.dat')
	ELSE IF (SWNEPH.EQ.'jm') THEN
	NSEG=7
	OPEN(4,FILE='pnmeshjm.dat')
	ELSE
	PRINT 200
  200   FORMAT (' NO NEPHRON SELECTED')
	STOP
	ENDIF
C
	PRINT 3
    3   FORMAT(' MESH SPACING - DATA FILE OR INTERACTIVE? (d/i):',$)
	READ *, SWI
	IF (SWI.EQ.'i') GO TO 7
	READ (4,5) (CHOP(L),DCHOP(L),L=1,NSEG)
    5   FORMAT(2I5)
	GO TO 12
C
    7   DO 10 K=1,NSEG
	IF (SWNEPH.EQ.'sf') THEN
	PRINT 8, SEGNAMSF(K)
	ELSE IF (SWNEPH.EQ.'jm') THEN
	PRINT 8, SEGNAMJM(K)
	ENDIF
    8   FORMAT(A5,' SPATIAL CHOP, AND PRINT SPACING:',$) 
	READ *, CHOP(K),DCHOP(K)
   10   CONTINUE
C
   12   DO 13 L=1,NSEG
   13   CHOP(L)=CHOP(L)+1
C
	PRINT 500
  500   FORMAT(' IS INPUT FROM A DATA FILE OR INTERACTIVE? (d/i): ',$)
	READ 30, SWI
  510   IF (SWI.EQ.'i') GO TO 15
	PRINT 516
  516   FORMAT(' TYPE THE VARIABLE FILENAME:',$)
	READ 514, VARNAM
  514   FORMAT(A12)
	OPEN(5,FILE=VARNAM)
	READ (5,515) NWR
  515   FORMAT(3X,I2)
	DO 525 KWR=1,NWR
  525   READ (5,530) VNAME1(KWR),VNAME2(KWR),SCALE(KWR)
  530   FORMAT(2A5,E10.2)
	GO TO 801
C
C
   15   PRINT 16
   16   FORMAT(' TYPE THE NUMBER OF VARIABLES TO BE REWRITTEN')
	READ *, NWR
	DO 50 KWR=1,NWR
	VNAME1(KWR)='fkm'
	PRINT 20, KWR
   20   FORMAT(' TYPE THE SPECIES NUMBER',I2,":",2X,$) 
   30   FORMAT(A5)
	READ 30, VNAME2(KWR)
	PRINT 22, KWR
   22   FORMAT(' TYPE THE SCALE NUMBER',I2,":",2X,$) 
	READ *, SCALE(KWR)
   50   CONTINUE
C
C THE WRITTEN VARIABLES HAVE BEEN SPECIFIED, AS HAS TUBULE SEGMENTATION
C
  801   DO 900 KXP=1,100
C
C DATA FOR EACH SEGMENT IS READ
C
	DO 820 ISEG=1,NSEG
	DO 810 KWR=1,NWR
  810   CALL SELEC 
     1   (VNAME1(KWR),VNAME2(KWR),IWR(KWR),JWR(KWR),CHOP(ISEG))
        IF(ISEG.EQ.1) THEN
 	CALL RDPT(CHOP(ISEG),*811,*901)
        ELSE IF(ISEG.EQ.2) THEN
 	CALL RDPT(CHOP(ISEG),*811,*901)
        ELSE
	CALL RDSEG(CHOP(ISEG),*811,*901)
	ENDIF
  811   DO 817 J=1,NWR
	WRDL(ISEG,J,KXP)=SCALE(J)*DL(J)
	WREX(ISEG,J,KXP)=SCALE(J)*EX(J)
  817   WRRES(ISEG,J,KXP)=SCALE(J)*RDRES(J)
	WRTIM(ISEG,KXP)=TTIM
  820   CONTINUE
C	
C THIS IS THE TOTAL PN
C
	WRTIM(NSEG+1,KXP) = 0.D0
	DO 856 ISEG=1,NSEG
  856   WRTIM(NSEG+1,KXP) = WRTIM(NSEG+1,KXP) + WRTIM(ISEG,KXP)
	DO 858 J=1,NWR
	WRRES(NSEG+1,J,KXP) = 0.D0
	DO 857 ISEG=1,NSEG
  857   WRRES(NSEG+1,J,KXP) = WRRES(NSEG+1,J,KXP) + WRRES(ISEG,J,KXP)
  858   CONTINUE
C
  900   CONTINUE
C
C WRRES HAS BEEN FILLED. 
C
  901   KXP=KXP-1
	IF (SWNEPH.EQ.'sf') THEN
	WRITE (2,902) (SEGNAMSF(I),I=1,NSEG)
	ELSE IF (SWNEPH.EQ.'jm') THEN
	WRITE (2,902) (SEGNAMJM(I),I=1,NSEG)
	ENDIF
  902   FORMAT(///,10X,7(A5,7X),'TOTAL')
	DO 910 K=1,KXP
	WRITE (2,907)
  907   FORMAT(/,2X,'transit time',/)
	WRITE (2,917) (WRTIM(ISEG,K),ISEG=1,NSEG+1)
	WRITE (2,903) 
  903   FORMAT(/,2X,'absolute delivery',/)
	DO 923 J=1,NWR
  923   WRITE (2,915) VNAME2(J),(WRDL(ISEG,J,K),ISEG=1,NSEG),
     1     WREX(NSEG,J,K)
	WRITE (2,904) 
  904   FORMAT(/,2X,'absolute reabsorption',/)
	DO 924 J=1,NWR
  924   WRITE (2,915) VNAME2(J),(WRRES(ISEG,J,K),ISEG=1,NSEG),
     1     WRRES(NSEG+1,J,K)
	WRITE (2,905) 
  905   FORMAT(/,2X,'reabsorption relative to segmental delivery',/)
	DO 925 J=1,NWR
  925   WRITE (2,916) VNAME2(J),
     1     (WRRES(ISEG,J,K)/WRDL(ISEG,J,K),ISEG=1,NSEG),
     1     WRRES(NSEG+1,J,K)/WRDL(1,J,K)
	WRITE (2,906) 
  906   FORMAT(/,2X,'reabsorption relative to pct delivery',/)
	DO 926 J=1,NWR
  926   WRITE (2,916) VNAME2(J),
     1     (WRRES(ISEG,J,K)/WRDL(1,J,K),ISEG=1,NSEG),
     1     WRRES(NSEG+1,J,K)/WRDL(1,J,K)
  910   CONTINUE
  915   FORMAT (1X,A5,8E12.4)
  916   FORMAT (1X,A5,8F12.4)
  917   FORMAT (6X,8F12.4)
C
	STOP
	END
C
C
	SUBROUTINE SELEC(VNAME1,VNAME2,IWR,JWR,CHOP)
C PROGRAM TO ASSIGN THE ARRAY COORDINATES FOR THE OUTPUT VARIABLES
C
	INTEGER IWR,JWR,CHOP
        CHARACTER*5 VNAME1,VNAME2
C
C
	IF(VNAME1.EQ.'vm') GO TO 501
	IF(VNAME1.EQ.'pm') GO TO 502
	IF(VNAME1.EQ.'cm') GO TO 503
	IF(VNAME1.EQ.'phm') GO TO 504
	IF(VNAME1.EQ.'xm') GO TO 505
	IF(VNAME1.EQ.'fvm') GO TO 506
	IF(VNAME1.EQ.'fkm') GO TO 507
C	IF(VNAME1.EQ.'pheq') GO TO 508
	IF(VNAME1.EQ.'ta') GO TO 508
	IF(VNAME1.EQ.'osmm') GO TO 509
C
C
  501   IWR=1
	JWR=2
	GO TO 700
  502   IWR=1
	JWR=3
	GO TO 700
  503   IWR=1
	JWR=4
	GO TO 600
  508   IWR=1+CHOP
	JWR=2
	GO TO 700
  504   IWR=1+CHOP
	JWR=3
	GO TO 700
  505   IWR=1+CHOP
	JWR=4
	GO TO 600
  506   IWR=1+2*CHOP
	JWR=3
	GO TO 700
  507   IWR=1+2*CHOP
	JWR=4
	GO TO 600
  509   IWR=1+2*CHOP
	JWR=2
	GO TO 700
C
C
  600   CONTINUE
C
	IF(VNAME2.EQ.'na') GO TO 621
	IF(VNAME2.EQ.'k') GO TO 622
	IF(VNAME2.EQ.'cl') GO TO 623
	IF(VNAME2.EQ.'hco3') GO TO 624
	IF(VNAME2.EQ.'h2co3') GO TO 625
	IF(VNAME2.EQ.'co2') GO TO 626
	IF(VNAME2.EQ.'hpo4') GO TO 627
	IF(VNAME2.EQ.'h2po4') GO TO 628
	IF(VNAME2.EQ.'urea') GO TO 629
	IF(VNAME2.EQ.'nh3') GO TO 630
	IF(VNAME2.EQ.'nh4') GO TO 631
	IF(VNAME2.EQ.'h') GO TO 632
	IF(VNAME2.EQ.'impm') GO TO 632
	IF(VNAME2.EQ.'ta') GO TO 632
C
C
  621   JWR=JWR+0
	GO TO 700
  622   JWR=JWR+1
	GO TO 700
  623   JWR=JWR+2
	GO TO 700
  624   JWR=JWR+3
	GO TO 700
  625   JWR=JWR+4
	GO TO 700
  626   JWR=JWR+5
	GO TO 700
  627   JWR=JWR+6
	GO TO 700
  628   JWR=JWR+7
	GO TO 700
  629   JWR=JWR+8
	GO TO 700
  630   JWR=JWR+9
	GO TO 700
  631   JWR=JWR+10
	GO TO 700
  632   JWR=JWR+11
	GO TO 700
C
  700   CONTINUE
	RETURN
	END
C
C
	SUBROUTINE RDSEG(CHOP,*,*)
C PROGRAM TO READ THE TUBULE SEGMENT RECORDS AND OUTPUT THE SELECTED VARIABLES
C
	INTEGER NWR,IWR(20),JWR(20),CHOP
	REAL RES(4803,16),TIME,RDRES(20),DL(20),EX(20)
C
	COMMON/TWR/NWR,IWR,JWR,TIME,RDRES,DL,EX
C
C
  300   READ (1,310,END=360) TIME
  310   FORMAT (2(/),11X,F15.4)
	READ (1,325) ((RES(I,J),J=1,15),I=1,CHOP)
  325   FORMAT (///,(F7.4,F9.4,F9.2,4F9.6,D9.3,4F9.6,D9.3,2F9.6))
	READ (1,335) ((RES(I,J),J=1,15),I=1+CHOP,2*CHOP)
  335   FORMAT (///,(F7.4,14F9.4))
	READ (1,345) ((RES(I,J),J=1,15),I=1+2*CHOP,3*CHOP)
  345   FORMAT (///,(F7.4,6F9.6,D9.3,4F9.6,D9.3,2F9.6))
C
	DO 350 J=1,NWR
	DL(J) = RES(IWR(J),JWR(J))
	EX(J) = RES(IWR(J)+CHOP-1,JWR(J))
  350   RDRES(J)=RES(IWR(J),JWR(J)) - RES(IWR(J)+CHOP-1,JWR(J))
C
	RETURN 1
  360   RETURN 2
	END
C
	SUBROUTINE RDPT(CHOP,*,*)
C PROGRAM TO READ THE TUBULE SEGMENT RECORDS AND OUTPUT THE SELECTED VARIABLES
C
	INTEGER NWR,IWR(20),JWR(20),CHOP
	REAL RES(4803,20),TIME,RDRES(20),DL(20),EX(20)
 
	COMMON/TWR/NWR,IWR,JWR,TIME,RDRES,DL,EX
C
C
  400   READ (1,410,END=460) TIME
  410   FORMAT (2(/),11X,F15.4)
	READ (1,425) ((RES(I,J),J=1,18),I=1,CHOP)
  425   FORMAT (///,
     1    (F7.4,F9.4,F9.2,4F9.6,D9.3,4F9.6,D9.3,2F9.6,D9.3,2F9.6))
	READ (1,435) ((RES(I,J),J=1,18),I=1+CHOP,2*CHOP)
  435   FORMAT (///,(F7.4,17F9.4))
	READ (1,445) ((RES(I,J),J=1,18),I=1+2*CHOP,3*CHOP)
  445   FORMAT (///,(F7.4,6F9.6,D9.3,4F9.6,D9.3,2F9.6,D9.3,2F9.6))
C
	DO 450 J=1,NWR
        IF(JWR(J).EQ.15) JWR(J)=18
	DL(J) = RES(IWR(J),JWR(J))
	EX(J) = RES(IWR(J)+CHOP-1,JWR(J))
        RDRES(J)=RES(IWR(J),JWR(J)) - RES(IWR(J)+CHOP-1,JWR(J))
  450   IF(JWR(J).EQ.18) JWR(J)=15
C
	RETURN 1
  460   RETURN 2
	END
C
