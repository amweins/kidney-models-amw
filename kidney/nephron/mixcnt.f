	SUBROUTINE MIXCNT
C
C TO TAKE SIX INFLOWS WITH BUFFERED SOLUTES AND COMBINE TO A SINGLE OUTFLOW
C THE MIXING IS ASSUMED TO BE INSTANTANEOUS, WITH NO CO2 HYDRATION/DEHYDRATION
C OTHER BUFFERS ARE AT EQUILIBRIUM; CO2 EQUILIBRATION OCCURS ALONG THE TUBULE
C
	INTEGER SOLS,NTUB
C
C       SOLS-   NUMBER OF SOLUTES
C	NTUB-	NUMBER OF INPUT TUBULES
C       TUBULE INDICES: 1- SF, 2-6- JM, 7- OUTFLOW
C
C LUMINAL VARIABLES
	DOUBLE PRECISION PKC,PKN,PKP,
     1   CM(15,10),IMPM(10),LCHM(10),FVM(10),FKM(16,10)
C
C       CM-     LUMINAL SOLUTE CONCENTRATION
C       IMPM-   LUMINAL IMPERMEANT (INCL GLUCOSE)
C       LCHM-   LUMINAL PH
C	FVM-	LUMINAL VOLUME FLOW RATE
C	FKM-	LUMINAL SOLUTE FLUX RATE
C
	DOUBLE PRECISION 
     1   TCM,TPM,TNM,QCM,QPM,QNM,
     1   EPSI,PHI,GAMMA,DGAM,PPHI,NDERIV
C
C       TCM-    SUM OF HCO3 + H2CO3
C       TPM-    TOTAL PHOSPHATE
C       TNM-    TOTAL AMMONIA
C       QCM-    RATIO OF BASE TO ACID FOR HCO3
C       QPM-    RATIO OF BASE TO ACID FOR HPO4
C       QNM-    RATIO OF BASE TO ACID FOR NH3
C
C       EPSI-   ERROR TOLERANCE
C       PHI-    ERROR - TO BE ZEROED VIA NEWTON ITERATION
C       GAMMA-  SOLUTION VARIABLE 
C       DGAM-   VARIABLE INCREMENT TO COMPUTE NUMERICAL DERIVATIVE
C       PPHI-   ERROR VECTOR AT GAMMA + DGAM
C       NDERIV- NUMERICAL DERIVATIVE OF PHI WITH RESPECT TO GAMMA
C
C ARCHIVE VARIABLES
C
C Segment numbers (ISEG)
C      1- PCT
C      2- PST
C      3- sDHL, lDHLu
C      4- lDHLl
C      5- tAHL
C      6- AHLm
C      7- AHLc
C      8- DCT
C      9- CNT
C      10-CCD
C      11-OMCD
C      12-IMCD
C
	INTEGER IARCH,INEPH,ISEG
C  IARCH = 0 (ARCHIVE) 
C        = 1 (RETRIEVE EVERYTHING) 
C        = 2 (INITIALIZE THE NEXT SEGMENT)
C        = 3 (RETRIEVE EVERYTHING EXCEPT X=1 VARIABLES)
C
	INTEGER 
     1   RX(6,12), RCHOP(6,12)
C
C GENERAL PARAMETERS
	DOUBLE PRECISION
     1   RDIST(6,12), REPSI(6,12), RL0(6,12),
     1   RL(6,12,901,2), RKHY(6,12,5), RKDHY(6,12,5), RBCO2(6,12,3)
C
C LUMINAL AND PERITUBULAR PARAMETERS
	DOUBLE PRECISION
     1   RVM(6,12,901,2), RPM(6,12,901,2), RCM(6,12,15,901,2),
     1   RIMPM(6,12,901,2), RLCHM(6,12,901), RXM(6,12,15,901),
     1   RVS(6,12,901,2), RPS(6,12,901,2), RCS(6,12,15,901,2),
     1   RIMPS(6,12,901,2), RLCHS(6,12,901), RXS(6,12,15,901),
     1   RTL(6,12), RDX(6,12), RRM0(6,12),
     1   RMUM(6,12), RETA(6,12), RSM(6,12,901,2),
     1   RAM(6,12,901,2), RFVM(6,12,901,2), RFKM(6,12,16,901,2)
C
C INTERSPACE PARAMETERS
	DOUBLE PRECISION
     1   RAME(6,12), RAE0(6,12), RAE(6,12,901,2),
     1   RMUA(6,12), RCHVL0(6,12), RCHVL(6,12,901,2),
     1   RMUV(6,12), RLPME(6,12), RLPES(6,12),
     1   RSME(6,12,15), RSES(6,12,15), RHME(6,12,15),
     1   RHES(6,12,15), RVE(6,12,901,2), RPE(6,12,901,2),
     1   RCE(6,12,15,901,2), RLCHE(6,12,901), RXE(6,12,15,901),
     1   RFEVM(6,12,901,2), RFEKM(6,12,15,901,2), RFEVS(6,12,901,2),
     1   RFEKS(6,12,15,901,2), RCURE(6,12,901)
C
C CELL PARAMETERS
	DOUBLE PRECISION
     1   RAIE(6,12,3), RAMI(6,12,3), RAIS(6,12,3),
     1   RAI0(6,12,3), RCLVL0(6,12,3), RIMP0(6,12,3),
     1   RCLVL(6,12,3,901,2), RZIMP(6,12,3), RTBUF(6,12,3),
     1   RPKB(6,12,3), RCBUF(6,12,3,901,2), RHCBUF(6,12,3,901,2),
     1   RLPMI(6,12,3), RLPIS(6,12,3), RSMI(6,12,3,15),
     1   RSIS(6,12,3,15), RHMI(6,12,3,15), RHIS(6,12,3,15),
     1   RLMI(6,12,3,15,15), RLIS(6,12,3,15,15), RATMI(6,12,3,15,901),
     1   RATIS(6,12,3,15,901), RATIE(6,12,3,15,901), RVI(6,12,3,901,2),
     1   RPI(6,12,3,901,2), RCI(6,12,3,15,901,2), RIMP(6,12,3,901),
     1   RLCHI(6,12,3,901), RXI(6,12,3,15,901), RFIVM(6,12,3,901,2),
     1   RFIKM(6,12,3,15,901,2), RFIVS(6,12,3,901,2), 
     1   RFIKS(6,12,3,15,901,2), RCURI(6,12,3,901), 
     1   RJV(6,12,3,901,2), RJK(6,12,3,15,901,2)
C
C SPECIAL TRANSPORTERS
	CHARACTER*1 RISOFM(6,12)
	DOUBLE PRECISION
     1   RNP(6,12,3), RKNPN(6,12,3), RKNPK(6,12,3),
     1   RKNH4(6,12,3), RNPHK(6,12,3), RLHP(6,12,3),
     1   RXIHP(6,12,3), RXHP(6,12,3), RNAE1(6,12,3),
     1   RNTSC(6,12,3), RNNHE3(6,12,3), RJNAK(6,12,3,3,901,2),
     1   RJHK(6,12,3,901,2), RJHP(6,12,3,901,2), RJAE1(6,12,3,901,2),
     1   RJTSC(6,12,3,901,2), RJNHE3(6,12,3,3,901,2), RQIAMM(6,12),
     1   RNNKCC(6,12,3), RNKCL(6,12,3), RJNKCC(6,12,3,4,901,2),
     1   RJKCC(6,12,3,3,901,2)
C
C TORQUE AND COMPLIANCE VARIABLES
	DOUBLE PRECISION
     1   RTQM(6,12,501,2), RRM(6,12,501,2), RMUR(6,12), RSCALMI(6,12),
     1   RSCALIS(6,12), RVM0(6,12), RAM0(6,12), RTQM0(6,12),
     1   RLHP0(6,12,3), RNP0(6,12,3), RNNHE30(6,12,3), RLPMI0(6,12,3),
     1   RLPIS0(6,12,3), RHMI0(6,12,3,15), RHIS0(6,12,3,15),
     1   RLMI0(6,12,3,15,15), RLIS0(6,12,3,15,15), RQIAMM0(6,12),
     1   RMVL(6,12), RMVD(6,12), RRMT0(6,12)
C
	COMMON /ARCH/
     1   RX, RCHOP,
     1   RDIST, REPSI, RL0, RL, RKHY, RKDHY, RBCO2,
     1   RVM, RPM, RCM, RIMPM, RLCHM, RXM,
     1   RVS, RPS, RCS, RIMPS, RLCHS, RXS,
     1   RTL, RDX, RRM0, RMUM, RETA, RSM, RAM,
     1   RFVM, RFKM,
     1   RAME, RAE0, RAE, RMUA, RCHVL0, RCHVL,
     1   RMUV, RLPME, RLPES, RSME, RSES,
     1   RHME, RHES, RVE, RPE,
     1   RCE, RLCHE, RXE, RFEVM, RFEKM,
     1   RFEVS, RFEKS, RCURE,
     1   RAIE, RAMI, RAIS, RAI0, RCLVL0, RIMP0,
     1   RCLVL, RZIMP, RTBUF, RPKB, RCBUF, RHCBUF,
     1   RLPMI, RLPIS, RSMI, RSIS, RHMI, RHIS,
     1   RLMI, RLIS, RATMI, RATIS, RATIE, RVI, RPI,
     1   RCI, RIMP, RLCHI, RXI, RFIVM, RFIKM,
     1   RFIVS, RFIKS, RCURI, RJV, RJK, RISOFM,
     1   RNP, RKNPN, RKNPK, RKNH4, RNPHK, RLHP,
     1   RXIHP, RXHP, RNAE1, RNTSC, RNNHE3,
     1   RJNAK, RJHK, RJHP, RJAE1, RJTSC, RJNHE3,
     1   RQIAMM, RNNKCC, RNKCL, RJNKCC, RJKCC,
     1   RTQM, RRM, RMUR, RSCALMI, RSCALIS, 
     1   RVM0, RAM0, RTQM0, RLHP0, RNP0, RNNHE30,
     1   RLPMI0, RLPIS0, RHMI0, RHIS0, RLMI0, 
     1   RLIS0, RQIAMM0, RMVL, RMVD, RRMT0
C
C  SOLUTE INDEX:
C	1-	NA+
C	2-	K+
C	3-	CL-
C	4-	HCO3-
C	5-	H2CO3
C	6-	CO2
C	7-	HPO4--
C	8-	H2PO4-
C	9-	UREA
C	10-	NH3
C	11-	NH4+
C	12-	H+
C
C PARAMETERS ARE SET
C
	PKC=3.57
	PKP=6.8
	PKN=9.15
C
	SOLS=12
	NTUB=6
        NN=NTUB+1
C
        EPSI=1.D-15
	DGAM=1.D-4
C
C RETRIEVE THE FLOWS AND CONCENTRATIONS AT END-DCT (ISEG=8) FOR EACH OF THE 6 NEPHRONS 
C
        ISEG=8
	DO 220 INEPH = 1,NTUB
        IX = RCHOP(INEPH,ISEG)+1
	IMPM(INEPH) = RIMPM(INEPH,ISEG,IX,1)
	LCHM(INEPH) = RLCHM(INEPH,ISEG,IX)
	FVM(INEPH) = RFVM(INEPH,ISEG,IX,1)
	DO 219 ISOL = 1,SOLS
	CM(ISOL,INEPH) = RCM(INEPH,ISEG,ISOL,IX,1)
	FKM(ISOL,INEPH) = RFKM(INEPH,ISEG,ISOL,IX,1)
  219   CONTINUE
	FKM(SOLS+1,INEPH) = RFKM(INEPH,ISEG,SOLS+1,IX,1)
  220   CONTINUE
C
C START THE MIXING CALCULATION
C
        FVM(NN) = 0.D0
        DO 62 I=1,SOLS
   62   FKM(I,NN) = 0.D0
        FKM(SOLS+1,NN) = 0.D0
C
        DO 65 J=1,NTUB
        FVM(NN) = FVM(NN) + FVM(J)
        DO 64 I=1,SOLS
   64   FKM(I,NN) = FKM(I,NN) + FKM(I,J)
        FKM(SOLS+1,NN) = FKM(SOLS+1,NN) + FKM(SOLS+1,J)
   65   CONTINUE
C
C OUTFLOW CONCENTRATIONS:
C  THESE ARE ACCURATE FOR NON-REACTING SPECIES
C  AND WILL SERVE AS THE INITIAL GUESSES FOR THE BUFFER PAIRS
C
        DO 70 I=1,SOLS
   70   CM(I,NN) = FKM(I,NN)/FVM(NN)
        IMPM(NN) = FKM(SOLS+1,NN)/FVM(NN)
	LCHM(NN)=PKC + DLOG10(CM(4,NN)/CM(5,NN))
	TCM=CM(4,NN)+CM(5,NN)
	TPM=CM(7,NN)+CM(8,NN)
	TNM=CM(10,NN)+CM(11,NN)
C
	CM(SOLS,NN)=10.**(-LCHM(NN))
	QCM=10.**(LCHM(NN)-PKC)
	QPM=10.**(LCHM(NN)-PKP)
	QNM=10.**(LCHM(NN)-PKN)
C
	CM(5,NN)=TCM/(1.+QCM)
	CM(4,NN)=TCM-CM(5,NN)
	CM(8,NN)=TPM/(1.+QPM)
	CM(7,NN)=TPM-CM(8,NN)
	CM(11,NN)=TNM/(1.+QNM)
	CM(10,NN)=TNM-CM(11,NN)
C
C   START THE NEWTON ITERATION.
C
C	PRINT 78
   78   FORMAT(/,$)
   79   ITER=0
   80   ITER=ITER+1
C	PRINT 82, ITER
   82   FORMAT(6X,'MIX-ITER=',I5,$)
C
C THIS PHI REPRESENTS NET PROTON CREATION AT THE POINT OF MIXING
C
        PHI = FVM(NN)*CM(12,NN)-FKM(12,NN) +
     1   FVM(NN)*CM(5,NN)-FKM(5,NN) +
     1   FVM(NN)*CM(8,NN)-FKM(8,NN) +
     1   FVM(NN)*CM(11,NN)-FKM(11,NN)
C
C	PRINT 84, PHI
   84   FORMAT ('+',D12.4)
	IF(DABS(PHI).LT.EPSI) GO TO 98
C
C PHI IS TOO LARGE.
C   WE DETERMINE THE DERIVATIVE OF PHI WITH RESPECT TO GAMMA,
C AND STORE THIS IN NDERIV.
C
        GAMMA = LCHM(NN)
	GAMMA=GAMMA+DGAM
        LCHM(NN) = GAMMA
C
	CM(SOLS,NN)=10.**(-LCHM(NN))
	QCM=10.**(LCHM(NN)-PKC)
	QPM=10.**(LCHM(NN)-PKP)
	QNM=10.**(LCHM(NN)-PKN)
C
	CM(5,NN)=TCM/(1.+QCM)
	CM(4,NN)=TCM-CM(5,NN)
	CM(8,NN)=TPM/(1.+QPM)
	CM(7,NN)=TPM-CM(8,NN)
	CM(11,NN)=TNM/(1.+QNM)
	CM(10,NN)=TNM-CM(11,NN)
C
        PPHI = FVM(NN)*CM(12,NN)-FKM(12,NN) +
     1   FVM(NN)*CM(5,NN)-FKM(5,NN) +
     1   FVM(NN)*CM(8,NN)-FKM(8,NN) +
     1   FVM(NN)*CM(11,NN)-FKM(11,NN)
C
        NDERIV=(PPHI-PHI)/DGAM
	GAMMA=GAMMA-DGAM
C
C THE JACOBIAN HAS BEEN COMPUTED NUMERICALLY. THE CURRENT GUESSES
C SIT IN GAMMA AND THE ERRORS IN PHI.  IT REMAINS TO COMPUTE
C NDERIV-1(PHI) AT THE CORRECTION TO BE SUBTRACTED FROM GAMMA.
C
        GAMMA=GAMMA-PHI/NDERIV
C
C RESET THE GUESSES IN THE NAMES BY WHICH WE KNOW THEM.
C
        LCHM(NN) = GAMMA
C
	CM(SOLS,NN)=10.**(-LCHM(NN))
	QCM=10.**(LCHM(NN)-PKC)
	QPM=10.**(LCHM(NN)-PKP)
	QNM=10.**(LCHM(NN)-PKN)
C
	CM(5,NN)=TCM/(1.+QCM)
	CM(4,NN)=TCM-CM(5,NN)
	CM(8,NN)=TPM/(1.+QPM)
	CM(7,NN)=TPM-CM(8,NN)
	CM(11,NN)=TNM/(1.+QNM)
	CM(10,NN)=TNM-CM(11,NN)
C
	IF (ITER.LT.50) GO TO 80
C
C IF THE SPATIAL ITERATION FAILS TO CONVERGE THE PROGRAM STOPS.
	PRINT 92
  92    FORMAT (' TOO MANY ITERATIONS IN MIX')
	GO TO 100
C
C THE SPATIAL STEP CONVERGED,AND
C THE PROGRAM PICKS UP AT THIS POINT:
C
   98   CONTINUE
        DO 95 I=1,SOLS
   95   FKM(I,NN)=FVM(NN)*CM(I,NN)
C
C        PRINT 97
   97   FORMAT (' MIXING PROBLEM SOLVED')
C
C NOW PLACE THESE VALUES AS THE INITIAL VALUES IN ARCHIVE CNT
C
        ISEG=9
        INEPH=1
        IX=1
	RIMPM(INEPH,ISEG,IX,1) = IMPM(NN)
	RLCHM(INEPH,ISEG,IX) = LCHM(NN)
	RFVM(INEPH,ISEG,IX,1) = FVM(NN)
	DO 119 ISOL = 1,SOLS
	RCM(INEPH,ISEG,ISOL,IX,1) = CM(ISOL,NN)
	RFKM(INEPH,ISEG,ISOL,IX,1) = FKM(ISOL,NN)
  119   CONTINUE
	RFKM(INEPH,ISEG,SOLS+1,IX,1) = FKM(SOLS+1,NN)
C
C
  100   CONTINUE
        SOLS=15
        RETURN
	END
